<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurnal Karakter - Validasi Waktu Sholat</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --bg-color: #1e272e; --card-bg: #2d3436; --text-primary: #dfe6e9;
            --item-bg: #353b48; --locked: #636e72; --modal-overlay: rgba(0, 0, 0, 0.85);
            --accent: #00cec9; --danger: #d63031;
        }
        body {
            font-family: 'Nunito', sans-serif; background-color: var(--bg-color); color: var(--text-primary);
            margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; min-height: 100vh;
        }
        
        /* Container Utama */
        .container {
            width: 100%; max-width: 380px; background: var(--card-bg); border-radius: 24px;
            padding: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.6); display: none;
            animation: fadeIn 0.5s ease-out; box-sizing: border-box;
        }
        .container.guru-mode { max-width: 100% !important; padding: 10px; background: #dfe6e9; color: #2d3436; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* --- TAMPILAN TABEL RESPONSIF --- */
        .table-responsive {
            width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch;
            margin-top: 15px; border: 1px solid #b2bec3; background: white; border-radius: 8px;
        }

        #areaPrint table {
            width: 100%; min-width: 1000px; border-collapse: collapse; font-size: 0.9rem; color: black;
        }

        #areaPrint th, #areaPrint td {
            padding: 8px 5px; text-align: center; border: 1px solid #636e72; vertical-align: middle;
        }

        #areaPrint th { background-color: #f1f2f6; font-weight: bold; height: 40px; }

        #areaPrint th:nth-child(2), #areaPrint td:nth-child(2) {
            position: sticky; left: 0; background-color: #fff; z-index: 5;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1); min-width: 140px; max-width: 140px;
        }
        #areaPrint th:nth-child(2) { background-color: #f1f2f6; z-index: 10; }

        .sholat-text-grid { display: grid; grid-template-columns: 1fr; gap: 2px; text-align: left; font-size: 0.75rem; line-height: 1.2; }

        /* --- UI UTAMA --- */
        .login-header-icon { font-size: 4rem; text-align: center; display: block; animation: waveHand 2s infinite ease-in-out; transform-origin: 70% 70%; }
        @keyframes waveHand { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(15deg); } }
        
        h2, h3 { text-align: center; margin-top: 0; margin-bottom: 20px; }
        h2 { font-size: 1.4rem; color: #fff;}
        .guru-mode h3 { color: #2d3436; margin-bottom: 5px; }

        .role-container { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
        .role-card {
            width: 130px; height: 130px; border: none; border-radius: 20px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.2s; color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .role-card:hover { transform: scale(1.05); }
        .role-siswa { background: linear-gradient(135deg, #00b894, #00cec9); }
        .role-guru { background: linear-gradient(135deg, #0984e3, #6c5ce7); }
        .role-icon { font-size: 2.5rem; margin-bottom: 8px; }
        .role-title { font-size: 0.95rem; font-weight: bold; }

        .input-group { margin-bottom: 15px; }
        .input-label { font-size: 0.85rem; color: #b2bec3; margin-bottom: 5px; display: block; margin-left: 5px; }
        .input-box {
            width: 100%; padding: 12px; background: var(--item-bg); border: 2px solid var(--item-bg);
            color: white; border-radius: 10px; box-sizing: border-box; text-align: center; font-size: 1rem;
        }
        .input-box:focus { border-color: #0984e3; outline: none; }
        .wali-box { background: #2d3436; border: 1px solid var(--accent); color: var(--accent); font-weight: bold; }
        .input-box:disabled { background-color: var(--locked); color: #b2bec3; cursor: not-allowed; }

        #habitList { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .habit-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: var(--item-bg); padding: 12px; border-radius: 16px; text-align: center; gap: 8px;
            border: 2px solid var(--theme-color); transition: 0.3s; cursor: pointer;
        }
        .habit-item.disabled-state { opacity: 0.4; filter: grayscale(1); cursor: not-allowed; border-color: #636e72; }
        .habit-item.done-state { background-color: var(--theme-bg); box-shadow: 0 0 15px var(--theme-color); border-color: transparent; }
        .habit-item.locked-state { opacity: 0.8; pointer-events: none; }
        .habit-item.hidden-habit { display: none !important; }
        .habit-text { font-weight: bold; font-size: 0.9rem; color: var(--theme-color); }
        .time-badge {
            min-width: 60px; height: 25px; border-radius: 15px; border: 2px solid var(--theme-color);
            color: var(--theme-color); font-size: 0.85rem; font-weight: bold; display: flex;
            align-items: center; justify-content: center; font-family: 'Courier New', monospace;
        }
        .time-badge.active { background: var(--theme-color); color: #1e272e; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
        
        .action-btn { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: white; font-size: 1rem; }
        .action-btn:disabled { background-color: var(--locked) !important; cursor: not-allowed; }
        .btn-back { background: transparent; color: inherit; border: 1px solid #636e72; margin-bottom: 10px; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; }
        
        #statusMessage { text-align: center; font-weight: bold; margin-bottom: 10px; padding: 10px; border-radius: 8px; display: none; }

        /* --- MODAL SHOLAT GRID 2 KOLOM --- */
        #modalSholat { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); width: 90%; max-width: 350px; padding: 20px; border-radius: 20px; text-align: center; border: 2px solid var(--accent); animation: popUp 0.3s ease-out; }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        #sholat-buttons-container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 15px 0;
        }

        .btn-sholat-sub {
            padding: 10px; background: var(--item-bg); border: 1px solid var(--accent); color: white;
            border-radius: 12px; cursor: pointer; font-size: 0.9rem; display: flex; flex-direction: column;
            align-items: center; justify-content: center; height: 85px; transition: 0.2s; position: relative;
        }

        /* Span 2 untuk Isya */
        #sholat-buttons-container button:last-child { grid-column: span 2; }
        .btn-sholat-sub:hover { transform: scale(1.02); }
        
        .sholat-icon-large { font-size: 1.5rem; margin-bottom: 4px; }
        .sholat-name { font-weight: bold; font-size: 1rem; }
        .sub-time { font-size: 0.75rem; color: #b2bec3; margin-top: 2px;}

        /* Status Visual Tombol Sholat */
        .btn-sholat-sub.done { background: var(--accent); color: #2d3436; border-color: transparent; }
        .btn-sholat-sub.done .sub-time { color: #2d3436; font-weight: bold; }
        
        /* Tombol Terkunci (Belum/Terlewat) */
        .btn-sholat-sub.locked-time { 
            opacity: 0.5; 
            background: #2d3436; 
            border-color: #636e72; 
            cursor: not-allowed; 
        }

        .close-modal { background: var(--danger); color: white; border: none; padding: 10px 30px; border-radius: 20px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px;}

        /* Tombol Guru & Login */
        .guru-actions { display: flex; gap: 5px; }
        .btn-download, .btn-reset { padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: bold; border: none; color: white; font-size: 0.85rem; }
        .btn-download { background: #0984e3; } .btn-reset { background: var(--danger); }
        
        /* SweetAlert Customization */
        div:where(.swal2-container) div:where(.swal2-popup) { 
            background: #2d3436 !important; color: #dfe6e9 !important; border-radius: 20px !important; 
        }
        div:where(.swal2-input) {
            text-align: center !important; width: 180px !important; margin: 10px auto !important;
            background: #353b48 !important; color: white !important; border: 2px solid #00cec9 !important;
        }
        div:where(.swal2-actions) button { padding: 8px 15px !important; font-size: 1.2rem !important; }
    </style>
</head>
<body>

    <div id="page-login" class="container" style="display: block;">
        <div class="login-header-icon">üëã</div>
        <h2>Jurnal 7 KAIH</h2>
        <div class="role-container">
            <button class="role-card role-siswa" onclick="bukaHalaman('page-siswa')">
                <div class="role-icon">üìö</div><div class="role-title">SISWA</div>
            </button>
            <button class="role-card role-guru" onclick="cekLoginGuru()">
                <div class="role-icon">üë®‚Äçüè´</div><div class="role-title">GURU</div>
            </button>
        </div>
    </div>

    <div id="page-siswa" class="container">
        <button class="btn-back" onclick="bukaHalaman('page-login')">‚¨Ö Kembali</button>
        <h3>Jurnal Harian</h3>
        <div id="statusMessage"></div>
        
        <div class="input-group">
            <label class="input-label">Nama Guru Wali</label>
            <input type="text" id="displayWaliKelas" class="input-box wali-box" placeholder="-" disabled>
        </div>
        <div class="input-group">
            <label class="input-label">Pilih Kelas</label>
            <select id="inputKelas" class="input-box" onchange="loadDaftarNama()"><option value="">-- Pilih Kelas --</option></select>
        </div>
        <div class="input-group" style="margin-bottom: 20px;">
            <label class="input-label">Nama Murid</label>
            <div id="containerNama"><input type="text" class="input-box" placeholder="Pilih Kelas dulu..." disabled></div>
        </div>
        
        <div id="habitList"></div>
        <textarea id="inputRefleksi" class="input-box" rows="2" placeholder="Catatan hari ini (opsional)..." style="text-align: left;"></textarea>
        <button id="btnSubmit" class="action-btn" style="background: #00b894;" onclick="simpanDataSiswa()">üíæ Kirim Laporan</button>
    </div>

    <div id="modalSholat">
        <div class="modal-content">
            <h3 style="color: #00cec9; margin-bottom:5px;">üïå Sholat 5 Waktu</h3>
            <p style="font-size: 0.85rem; color:#b2bec3;">Klik waktu untuk validasi.</p>
            <div id="sholat-buttons-container"></div>
            <button class="close-modal" onclick="tutupModal()">Tutup / Simpan</button>
        </div>
    </div>

    <div id="page-guru" class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:10px;">
            <button class="btn-back" style="border-color:#2d3436; color:#2d3436" onclick="bukaHalaman('page-login')">‚¨Ö Logout</button>
            <div class="guru-actions">
                <button class="btn-download" onclick="simpanPDF()">üìÑ PDF</button>
                <button class="btn-reset" onclick="hapusSemuaData()">üóëÔ∏è Reset</button>
            </div>
        </div>
        
        <div id="areaPrint">
            <h3>SMPN 110 JAKARTA</h3>
            <p style="text-align:center; margin-top:-5px; font-weight:bold; font-size:1rem; color:#636e72">LAPORAN JURNAL KARAKTER</p>
            
            <div class="table-responsive">
                <div id="tabelDataContainer"></div>
            </div>
            <p style="font-size: 0.8rem; color: #d63031; margin-top: 5px;">*Geser tabel ke samping untuk melihat detail lengkap.</p>
        </div>
    </div>

<script>
    const DB_KEY = 'jurnal_sekolah_db_fix';
    let isLocked = false;
    let tempSholatData = { Subuh: null, Dzuhur: null, Ashar: null, Maghrib: null, Isya: null };

    const SHOLAT_ICONS = {
        Subuh: 'üåÖ', Dzuhur: '‚òÄÔ∏è', Ashar: 'üå§Ô∏è', Maghrib: 'üåÜ', Isya: 'üåô'
    };

    const HABITS = [
        { icon: "üåÖ", text: "Bangun", color: "#fdcb6e", bg: "rgba(253, 203, 110, 0.2)" },
        { icon: "üôè", text: "Ibadah", color: "#a29bfe", bg: "rgba(162, 155, 254, 0.2)" },
        { icon: "üïå", text: "Sholat 5W", color: "#00cec9", bg: "rgba(0, 206, 201, 0.2)", isSpecial: true },
        { icon: "‚öΩ", text: "Olahraga", color: "#ff7675", bg: "rgba(255, 118, 117, 0.2)" },
        { icon: "ü•ó", text: "Makan", color: "#55efc4", bg: "rgba(85, 239, 196, 0.2)" },
        { icon: "üìö", text: "Belajar", color: "#74b9ff", bg: "rgba(116, 185, 255, 0.2)" },
        { icon: "ü§ù", text: "Sosial", color: "#fd79a8", bg: "rgba(253, 121, 168, 0.2)" },
        { icon: "üò¥", text: "Tidur", color: "#81ecec", bg: "rgba(129, 236, 236, 0.2)" }
    ];

    const PRAYER_SCHEDULE = {
        Subuh: { start: "04:00", end: "06:00" }, Dzuhur: { start: "11:30", end: "15:00" },
        Ashar: { start: "15:00", end: "18:00" }, Maghrib: { start: "18:00", end: "19:00" },
        Isya: { start: "19:00", end: "23:59" }
    };

    const SISWA_7A_SUNARDI = [
        "Abdul Fatah Nasution", "Abdurrahman Alfarizi", "Adda Kaayuan Aulia Cakra Nirmala", 
        "Ahmad Fachri Firmansyah", "Ainnur Fadzillah", "Aishavira Salsabila", "Ardhyastha Prasetya", 
        "Azka Ibrahim", "Carissa Alya Ferica", "Charissa Aglessia Putri", "Dimas Putra Setiawan", 
        "Emira Khairunisa", "Fitri Yaumi", "Gagah Adhi Prakoso", "Janetha Putri Adellia", 
        "Kahla Ghaisa Shiba", "Kimiko Azura Yusell", "Lolita Aurora Hadi", "Mahira Handayani", 
        "Muhamad Rizki", "Muhammad Alim Raafi", "Muhammad Erlangga Syaqib", "Muhammad Fadhil Arsyad"
    ];

    const SISWA_ASRIL = [
        "Muhammad Fareez Pratama", "Muhammad Nizam", "Nalendra Zaki Mubarak", "Naysyilla Innayah", 
        "Pricellia Fauziah", "Randhika Rezky Wahyudi", "Sabian Fataya Adam Nugraha", "Satria Cahya Anggara", 
        "Tania Putri Christvie", "Tri Yusuf Jamal Ludin", "Usamah", "Zahfa Syachqilia",
        "Athaya Khansa Batubara", "Azri Sani Athallah", "Bima Ramadaska Nurzafran", 
        "Fakhirah Salwa Nabila Hakim", "Hanyya Mirfa Fadli", "Humairah Aulia Ramadhani Hilmi", 
        "Irfan Prasetya", "Jibran Nararya Putra", "Kanzania Zievara Akhmad", 
        "Kayla Mantika Hermansyah", "Khalifah Ramadhany"
    ];

    const SISWA_7B_SUNINGSIH = [
        "Michael Rahman Manoppo", "Mikayla Al Rasyid Febriana", "Muhamad Latif Albany Pasaribu",
        "Muhamad Rizky Alfadillah", "Muhammad Azzam Raziq", "Muhammad Daffa Alfarizki",
        "Muhammad Syailendra Ibrahim", "Nadia Alanna Irawan", "Napsah Djunaidi",
        "Nova Zara Pramudita", "Noval Ahmad Dhani", "Rahmania Azzahra",
        "Revalina Almaiza Fadillah", "Ridho Abiyu Kafi", "Rifki Nuril Huda",
        "Rifqi Azzam Saputra", "Rizky Nursyawali", "Salsa Aprilia Putri",
        "Syafa Haliza Putri", "Syafia Nayla Zahra", "Vikryzaky Ariza",
        "Yake Fain Seto", "Zaky Alfaridzi Ahmad"
    ];

    const DATA_KELAS = {
        "7A": [...SISWA_7A_SUNARDI, ...SISWA_ASRIL.slice(0, 12)].sort(),
        "7B": [...SISWA_ASRIL.slice(12), ...SISWA_7B_SUNINGSIH].sort()
    };

    window.onload = function() {
        const sel = document.getElementById('inputKelas');
        ['7','8','9'].forEach(l => ['A','B','C','D','E','F'].forEach(c => {
            let o = document.createElement('option'); o.value = l+c; o.textContent = `Kelas ${l}${c}`;
            sel.appendChild(o);
        }));

        const hList = document.getElementById('habitList');
        HABITS.forEach((h, i) => {
            hList.innerHTML += `
            <div class="habit-item disabled-state" id="card-${i}" style="--theme-color: ${h.color}; --theme-bg: ${h.bg}" onclick="klikCard(${i})">
                <span class="habit-text">${h.icon} ${h.text}</span>
                <div id="badge-${i}" class="time-badge"></div>
            </div>`;
        });

        const mBody = document.getElementById('sholat-buttons-container');
        ['Subuh','Dzuhur','Ashar','Maghrib','Isya'].forEach(s => {
            mBody.innerHTML += `
            <button id="sholat-${s}" class="btn-sholat-sub" onclick="klikSubSholat('${s}')">
                <div class="sholat-icon-large">${SHOLAT_ICONS[s]}</div>
                <div class="sholat-name">${s}</div>
                <div class="sub-time">-</div>
            </button>`;
        });
    };

    function loadDaftarNama() {
        const kls = document.getElementById('inputKelas').value;
        const cont = document.getElementById('containerNama');
        resetFormUI();
        if (!kls) {
            cont.innerHTML = `<input type="text" class="input-box" placeholder="Pilih Kelas dulu..." disabled>`;
            document.getElementById('displayWaliKelas').value = "-";
        } else if (DATA_KELAS[kls]) {
            let h = `<select id="inputNama" class="input-box" onchange="cekStatusLaporan()"><option value="">-- Pilih Namamu --</option>`;
            DATA_KELAS[kls].forEach(n => h += `<option value="${n}">${n}</option>`);
            cont.innerHTML = h + `</select>`;
        } else {
            cont.innerHTML = `<input type="text" id="inputNama" class="input-box" placeholder="Nama manual..." onblur="cekStatusLaporan()">`;
            document.getElementById('displayWaliKelas').value = "Belum Terdata";
        }
    }

    function updateWaliKelas(nama) {
        let guru = "Belum Ada Data";
        if (SISWA_7B_SUNINGSIH.includes(nama)) guru = "Suningsih, S.Pd.";
        else if (SISWA_ASRIL.includes(nama)) guru = "Bpk. Asril Yansah, S.Pd";
        else if (SISWA_7A_SUNARDI.includes(nama)) guru = "Bpk. H. Sunardi, M.Pd.";
        else {
            const kls = document.getElementById('inputKelas').value;
            if (kls === "7A") guru = "Bpk. H. Sunardi, M.Pd.";
            if (kls === "7C") guru = "Ibu Rina Melati";
        }
        document.getElementById('displayWaliKelas').value = guru;
    }

    function cekStatusLaporan() {
        const kls = document.getElementById('inputKelas').value;
        const elNama = document.getElementById('inputNama');
        const nama = elNama ? elNama.value : "";
        if (!nama || !kls) return;

        updateWaliKelas(nama);
        const today = new Date().toLocaleDateString('id-ID');
        const db = JSON.parse(localStorage.getItem(DB_KEY) || "[]");
        const riwayat = db.find(d => d.kelas === kls && d.nama === nama && d.tanggal === today);
        
        const btn = document.getElementById('btnSubmit');
        const msg = document.getElementById('statusMessage');

        if (riwayat) {
            isLocked = true;
            msg.style.display = 'block'; msg.style.color = '#ff7675'; msg.style.background = 'rgba(214, 48, 49, 0.2)';
            msg.innerHTML = `‚ö†Ô∏è Hai ${nama}, laporan hari ini sudah dikirim!`;
            btn.disabled = true; btn.innerText = "üîí Terkunci";
            document.getElementById('inputRefleksi').value = riwayat.refleksi || "";
            document.getElementById('inputRefleksi').disabled = true;
            riwayat.detail.forEach((val, i) => {
                const card = document.getElementById(`card-${i}`);
                card.classList.remove('disabled-state'); card.classList.add('locked-state');
                if (i === 2 && val && typeof val === 'object') { 
                    tempSholatData = val; updateTampilanUtamaSholat();
                } else if (val) {
                    document.getElementById(`badge-${i}`).classList.add('active');
                    document.getElementById(`badge-${i}`).innerText = val;
                    card.classList.add('done-state');
                }
            });
            cekKonflikIbadah();
        } else {
            isLocked = false;
            msg.style.display = 'none';
            btn.disabled = false; btn.innerText = "üíæ Kirim Laporan";
            document.getElementById('inputRefleksi').disabled = false;
            HABITS.forEach((_, i) => document.getElementById(`card-${i}`).classList.remove('disabled-state'));
        }
    }

    function klikCard(i) {
        if (isLocked || document.getElementById(`card-${i}`).classList.contains('disabled-state')) return;
        if (HABITS[i].isSpecial) { bukaModalSholat(); return; }
        const badge = document.getElementById(`badge-${i}`);
        if (badge.classList.contains('active')) { Swal.fire('Info', 'Sudah tercatat.', 'info'); return; }
        badge.classList.add('active');
        badge.innerText = new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}).replace('.',':');
        document.getElementById(`card-${i}`).classList.add('done-state');
        if (i === 1) cekKonflikIbadah();
    }

    function cekKonflikIbadah() {
        const ibadah = document.getElementById('badge-1').classList.contains('active');
        const sholat = Object.values(tempSholatData).some(x => x !== null);
        document.getElementById('card-1').classList.toggle('hidden-habit', sholat);
        document.getElementById('card-2').classList.toggle('hidden-habit', ibadah);
    }

    function bukaModalSholat() {
        document.getElementById('modalSholat').style.display = 'flex';
        const nowStr = new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
        const now = getMinutes(nowStr);

        ['Subuh','Dzuhur','Ashar','Maghrib','Isya'].forEach(s => {
            const btn = document.getElementById(`sholat-${s}`);
            const span = btn.querySelector('.sub-time');
            btn.className = "btn-sholat-sub"; // Reset class

            if (tempSholatData[s]) {
                btn.classList.add('done');
                span.innerText = tempSholatData[s];
            } else {
                const start = getMinutes(PRAYER_SCHEDULE[s].start);
                const end = getMinutes(PRAYER_SCHEDULE[s].end);
                
                if (now < start) {
                    btn.classList.add('locked-time');
                    span.innerText = "Belum Masuk";
                } else if (now > end) {
                    btn.classList.add('locked-time');
                    span.innerText = "Terlewat";
                } else {
                    span.innerText = "Isi Sekarang";
                }
            }
        });
    }

    function klikSubSholat(s) {
        if (tempSholatData[s]) {
            Swal.fire({icon:'info', title:'Sudah Tercatat', text:`Kamu sudah sholat ${s} pada ${tempSholatData[s]}`, confirmButtonColor:'#00cec9'});
            return;
        }

        const nowStr = new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}).replace('.', ':');
        const now = getMinutes(nowStr);
        const start = getMinutes(PRAYER_SCHEDULE[s].start);
        const end = getMinutes(PRAYER_SCHEDULE[s].end);

        // Validasi: Belum Waktunya
        if (now < start) {
            Swal.fire({
                icon: 'warning',
                title: 'Belum Waktunya',
                text: `Waktu ${s} belum masuk. Dimulai pukul ${PRAYER_SCHEDULE[s].start}.`,
                confirmButtonColor: '#fdcb6e'
            });
            return;
        }

        // Validasi: Sudah Terlewat
        if (now > end) {
            Swal.fire({
                icon: 'error',
                title: 'Waktu Habis',
                text: `Waktu ${s} sudah habis pada pukul ${PRAYER_SCHEDULE[s].end}.`,
                confirmButtonColor: '#d63031'
            });
            return;
        }

        // Jika Valid
        tempSholatData[s] = nowStr;
        bukaModalSholat();
        const count = Object.values(tempSholatData).filter(x => x).length;
        if(count === 5) { Swal.fire({icon:'success', title:'Alhamdulillah!', text:'Sholat 5 waktu lengkap.', timer:1500, showConfirmButton:false}); }
    }

    function tutupModal() { document.getElementById('modalSholat').style.display = 'none'; updateTampilanUtamaSholat(); cekKonflikIbadah(); }
    function updateTampilanUtamaSholat() {
        const count = Object.values(tempSholatData).filter(x => x).length;
        const b = document.getElementById('badge-2');
        const c = document.getElementById('card-2');
        if (count > 0) { b.classList.add('active'); b.innerText = `${count}/5`; c.classList.add('done-state'); }
        else { b.classList.remove('active'); b.innerText = ""; c.classList.remove('done-state'); }
    }
    
    function getMinutes(t) { 
        if(!t) return 0;
        const [h, m] = t.replace('.',':').split(':'); 
        return parseInt(h) * 60 + parseInt(m); 
    }

    function simpanDataSiswa() {
        if (isLocked) return;
        const kls = document.getElementById('inputKelas').value;
        const elNama = document.getElementById('inputNama');
        if (!kls || !elNama || !elNama.value) { Swal.fire('Error', 'Isi Nama & Kelas!', 'error'); return; }
        const detail = HABITS.map((h, i) => {
            if (h.isSpecial) return tempSholatData;
            return document.getElementById(`badge-${i}`).classList.contains('active') ? document.getElementById(`badge-${i}`).innerText : null;
        });
        const data = { id: Date.now(), tanggal: new Date().toLocaleDateString('id-ID'), kelas: kls, nama: elNama.value, wali: document.getElementById('displayWaliKelas').value, detail: detail, refleksi: document.getElementById('inputRefleksi').value };
        const db = JSON.parse(localStorage.getItem(DB_KEY) || "[]");
        db.push(data);
        localStorage.setItem(DB_KEY, JSON.stringify(db));
        Swal.fire({icon:'success', title:'Tersimpan!', timer:1500, showConfirmButton:false});
        cekStatusLaporan();
    }

    function cekLoginGuru() {
        Swal.fire({
            title: 'Akses Guru', 
            input: 'password', 
            showCancelButton: true, 
            confirmButtonColor: '#0984e3',
            cancelButtonColor: '#d63031',
            confirmButtonText: '‚úÖ',
            cancelButtonText: '‚ùå',
            preConfirm: (p) => p === "guru123" || Swal.showValidationMessage('Salah!')
        }).then((res) => { if(res.isConfirmed) bukaHalaman('page-guru'); });
    }

    function renderHalamanGuru() {
        const db = JSON.parse(localStorage.getItem(DB_KEY) || "[]");
        const div = document.getElementById('tabelDataContainer');
        if (!db.length) { div.innerHTML = "<p style='text-align:center'>Data Kosong</p>"; return; }
        db.sort((a,b) => (new Date(b.tanggal) - new Date(a.tanggal)) || a.kelas.localeCompare(b.kelas) || a.nama.localeCompare(b.nama));
        
        let headers = ""; HABITS.forEach((h, i) => { if(i!==2) headers += `<th>${i===1?'Ibadah/Sholat':h.text}</th>` });
        
        let rows = db.map((d, idx) => {
            let cols = "";
            d.detail.forEach((val, i) => {
                if (i === 2) return;
                if (i === 1) { 
                    const sholat = d.detail[2];
                    const isMuslim = sholat && Object.values(sholat).some(x=>x);
                    if (isMuslim) {
                        let sGrid = "<div class='sholat-text-grid'>";
                        ['Subuh','Dzuhur','Ashar','Maghrib','Isya'].forEach(k => { sGrid += `<div style="color:${sholat[k]?'black':'#b2bec3'}">${k.substr(0,1)}: ${sholat[k]||'-'}</div>`; });
                        cols += `<td>${sGrid}</div></td>`;
                    } else { cols += `<td>${val ? '‚úî '+val : '‚úñ'}</td>`; }
                } else { cols += `<td>${val ? '‚úî '+val : '‚úñ'}</td>`; }
            });
            return `<tr><td>${idx+1}</td><td style="text-align:left; font-weight:bold">${d.nama}<br><span style="font-weight:normal; font-size:0.75rem">${d.kelas} ‚Ä¢ ${d.tanggal}</span></td>${cols}<td style="text-align:left; min-width:100px; font-size:0.8rem">${d.refleksi||'-'}</td></tr>`;
        }).join('');
        div.innerHTML = `<table><thead><tr><th>No</th><th>Siswa</th>${headers}<th>Ket</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    function resetFormUI() {
        isLocked = false;
        tempSholatData = { Subuh:null, Dzuhur:null, Ashar:null, Maghrib:null, Isya:null };
        document.getElementById('statusMessage').style.display = 'none';
        document.getElementById('inputRefleksi').value = "";
        document.getElementById('btnSubmit').disabled = false;
        document.getElementById('btnSubmit').innerText = "üíæ Kirim Laporan";
        HABITS.forEach((_,i) => {
            const c = document.getElementById(`card-${i}`);
            const b = document.getElementById(`badge-${i}`);
            c.classList.remove('done-state','locked-state','hidden-habit'); c.classList.add('disabled-state');
            b.classList.remove('active'); b.innerText = "";
        });
    }

    function bukaHalaman(id) {
        document.querySelectorAll('.container').forEach(e => { e.style.display = 'none'; e.classList.remove('guru-mode'); });
        document.getElementById(id).style.display = 'block';
        if (id === 'page-guru') { document.getElementById(id).classList.add('guru-mode'); renderHalamanGuru(); }
        if (id === 'page-siswa') { document.getElementById('inputKelas').value = ""; loadDaftarNama(); }
    }

    function simpanPDF() {
        const el = document.getElementById('areaPrint');
        html2pdf().set({ margin:0.2, filename:'Jurnal.pdf', html2canvas:{scale:2}, jsPDF:{unit:'in', format:'legal', orientation:'landscape'} }).from(el).save();
    }
    
    function hapusSemuaData() {
        Swal.fire({ title:'Hapus?', icon:'warning', showCancelButton:true, confirmButtonColor:'#d63031', confirmButtonText:'Ya' })
        .then((r) => { if(r.isConfirmed) { localStorage.removeItem(DB_KEY); renderHalamanGuru(); } });
    }
</script>
</body>
</html>