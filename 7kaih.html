<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurnal 7 KAIH - SMPN 110 Jakarta</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #1e272e; --card: #2d3436; --txt: #dfe6e9; --acc: #00cec9; --danger: #d63031; --green: #00b894; }
        body { font-family: 'Nunito', sans-serif; background: var(--bg); color: var(--txt); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        
        /* CSS Input & Select */
        .swal2-input, .swal2-select { text-align: center !important; border-radius: 12px !important; }

        /* Menu Utama */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; margin-top: 25px; }
        .btn-square { 
            aspect-ratio: 1 / 1; border-radius: 28px; border: none; color: white; font-weight: 800; 
            cursor: pointer; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; gap: 12px; font-size: 0.9rem; text-align: center; padding: 15px; transition: 0.3s;
            box-shadow: 0 8px 15px rgba(0,0,0,0.3);
        }
        .btn-square span { font-size: 3.5rem; }

        .container { width: 100%; max-width: 420px; background: var(--card); border-radius: 24px; padding: 20px; display: none; box-sizing: border-box; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .container.guru-mode { max-width: 98% !important; background: #fff; color: #2d3436; }

        h2 { text-align: center; margin-bottom: 5px; font-weight: 800; }
        .input-box { width: 100%; padding: 14px; background: #353b48; border: 2px solid #444; color: #fff; border-radius: 12px; box-sizing: border-box; margin-bottom: 15px; font-family: inherit; font-size: 1rem; text-align: center; }
        
        /* Grid Kartu Habit & Sholat */
        #habitList, .sholat-popup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        
        .habit-item, .sholat-card { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 15px 10px; border-radius: 20px; border: 3px solid var(--c); 
            cursor: pointer; transition: 0.4s; background: transparent; color: white;
        }
        .habit-item { opacity: 0.3; } 
        .habit-item.done { opacity: 1; background: var(--b); }
        
        .sholat-card { opacity: 1; background: rgba(255,255,255,0.05); }
        .sholat-card:active { transform: scale(0.9); }

        .habit-icon { font-size: 2rem; margin-bottom: 5px; }
        .habit-text { font-size: 0.85rem; font-weight: 800; text-transform: uppercase; }
        .time-badge { margin-top: 5px; font-size: 0.8rem; background: rgba(0,0,0,0.4); padding: 2px 10px; border-radius: 8px; color: #fff; font-weight: 800; }

        .hidden { display: none !important; }
        .btn-save { background: var(--green); color: white; width: 100%; padding: 16px; border: none; border-radius: 14px; font-weight: 800; cursor: pointer; font-size: 1.1rem; }
        
        /* Table Style Guru */
        .table-res { width: 100%; overflow-x: auto; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; min-width: 1100px; font-size: 0.85rem; }
        th { background: #0984e3; color: white; padding: 12px; }
        td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; color: #333; }
    </style>
</head>
<body>

    <div id="p-login" class="container" style="display: block; text-align: center;">
        <div style="font-size: 4.5rem; margin-bottom: 10px;">üè´</div>
        <h2>JURNAL 7 KAIH</h2>
        <p style="opacity: 0.8; font-weight: 800; color: var(--acc);">SMPN 110 JAKARTA</p>
        <div class="menu-grid">
            <button class="btn-square" style="background: var(--green);" onclick="move('p-siswa')"><span>üë®‚Äçüéì</span>MENU SISWA</button>
            <button class="btn-square" style="background: #0984e3;" onclick="loginGuru()"><span>üë®‚Äçüè´</span>MONITORING</button>
        </div>
    </div>

    <div id="p-siswa" class="container">
        <div onclick="move('p-login')" style="cursor:pointer; margin-bottom: 20px; font-weight: 800; color: var(--acc);">‚¨Ö KEMBALI</div>
        <select id="i-kelas" class="input-box" onchange="loadNama()"><option value="">-- PILIH KELAS --</option></select>
        <div id="c-nama"><select class="input-box" disabled><option>PILIH KELAS DULU</option></select></div>
        <input type="text" id="i-wali" class="input-box" readonly style="background:transparent; border:2px solid var(--acc); color:var(--acc); font-weight:800;" placeholder="WALI KELAS">
        
        <div id="habitList"></div>
        <textarea id="i-ref" class="input-box" rows="2" placeholder="Apa hal baik hari ini?"></textarea>
        <button class="btn-save" onclick="kirimData()">üíæ SIMPAN LAPORAN</button>
    </div>

    <div id="p-guru" class="container">
        <div style="text-align: center; margin-bottom: 15px;">
            <h1 style="font-size: 1.2rem; margin:0; color:#2d3436;">SMPN 110 JAKARTA</h1>
            <h1 style="font-size: 1.2rem; margin:0; color:#2d3436;">LAPORAN JURNAL 7 KEBIASAAN ANAK INDONESIA HEBAT</h1>
            <b id="subJudulGuru" style="color:#0984e3;">-</b>
            <hr>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="renderMonitoring()" style="padding: 8px 15px; border-radius: 8px; border:none; background:var(--acc); color:white; font-weight:800;">üîÑ Refresh</button>
                <button onclick="move('p-login')" style="padding: 8px 15px; border-radius: 8px; border:none; background:#eee; font-weight:800;">üö™ Keluar</button>
            </div>
        </div>
        <div class="table-res" id="tabelData"></div>
    </div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwEzKqpQjTDC_afpFWf5vtBYs_bSVDfSehhy6PdXu1PZ1Kqv05n05JD5-_v7p6Zx6ZqKg/exec'; 
    let DB_SISWA = [];
    let GURU_TERPILIH = "";

    // Data Sholat
    const SHOLAT_RULES = {
        'Subuh':   { start: '04:00', end: '06:15', icon: 'üåë', color: '#fdcb6e' },
        'Dzuhur':  { start: '11:45', end: '14:45', icon: '‚òÄÔ∏è', color: '#00cec9' },
        'Ashar':   { start: '15:15', end: '17:45', icon: 'üå§Ô∏è', color: '#ff7675' },
        'Maghrib': { start: '18:00', end: '19:10', icon: 'üåÖ', color: '#a29bfe' },
        'Isya':    { start: '19:15', end: '23:59', icon: 'üåô', color: '#74b9ff' }
    };

    const HABITS = [
        { i: "üåÖ", t: "Bangun", c: "#fdcb6e", b: "rgba(253,203,110,0.2)" },
        { i: "üôè", t: "Ibadah", c: "#a29bfe", b: "rgba(162,155,254,0.2)" },
        { i: "üïå", t: "Sholat 5W", c: "#00cec9", b: "rgba(0,206,201,0.2)" },
        { i: "‚öΩ", t: "Olahraga", c: "#ff7675", b: "rgba(255,118,117,0.2)" },
        { i: "ü•ó", t: "Makan", c: "#55efc4", b: "rgba(85,239,196,0.2)" },
        { i: "üìö", t: "Belajar", c: "#74b9ff", b: "rgba(116,185,255,0.2)" },
        { i: "ü§ù", t: "Sosial", c: "#fd79a8", b: "rgba(253,121,168,0.2)" },
        { i: "üò¥", t: "Tidur", c: "#81ecec", b: "rgba(129,236,236,0.2)" }
    ];

    window.onload = async () => {
        HABITS.forEach((h, i) => {
            document.getElementById('habitList').innerHTML += `
            <div class="habit-item" id="card-${i}" style="--c:${h.c}; --b:${h.b}" onclick="klikHabit(${i})">
                <span class="habit-icon">${h.i}</span><span class="habit-text">${h.t}</span>
                <div id="badge-${i}" class="time-badge">--:--</div>
            </div>`;
        });
        try {
            const r = await fetch(SCRIPT_URL + "?action=getSiswa");
            DB_SISWA = await r.json();
            [...new Set(DB_SISWA.map(x => x[0]))].sort().forEach(k => {
                let o = document.createElement('option'); o.value = k; o.textContent = "KELAS " + k;
                document.getElementById('i-kelas').appendChild(o);
            });
        } catch (e) { console.error(e); }
    };

    async function klikHabit(i) {
        if (i === 1) { 
            document.getElementById('card-2').classList.add('hidden'); 
            setDone(i); 
        } 
        else if (i === 2) { 
            document.getElementById('card-1').classList.add('hidden');
            let htmlSholat = `<div class="sholat-popup-grid">`;
            for (let s in SHOLAT_RULES) {
                const item = SHOLAT_RULES[s];
                htmlSholat += `
                <div class="sholat-card" style="--c:${item.color};" onclick="validasiSholat('${s}')">
                    <span class="habit-icon">${item.icon}</span><span class="habit-text">${s}</span>
                </div>`;
            }
            htmlSholat += `</div>`;
            Swal.fire({ title: 'PILIH WAKTU SHOLAT', background: '#2d3436', color: '#fff', showConfirmButton: false, showCancelButton: true, cancelButtonText: 'Batal', html: htmlSholat });
        } 
        else { setDone(i); }
    }

    window.validasiSholat = function(nama) {
        const skrg = new Date();
        const jamSkrg = skrg.getHours().toString().padStart(2, '0') + ":" + skrg.getMinutes().toString().padStart(2, '0');
        const range = SHOLAT_RULES[nama];

        if (jamSkrg < range.start) {
            Swal.fire({ icon: 'warning', title: 'Belum Waktunya!', text: `Sholat ${nama} mulai jam ${range.start}`, background: '#2d3436', color: '#fff' });
        } else if (jamSkrg > range.end) {
            Swal.fire({ icon: 'error', title: 'Sudah Terlewat!', text: `Batas ${nama} jam ${range.end}`, background: '#2d3436', color: '#fff' });
        } else {
            // Hanya tampil jam saja (permintaan: Isya dihapus)
            document.getElementById(`badge-2`).innerText = jamSkrg;
            document.getElementById(`card-2`).classList.add('done');
            Swal.fire({ icon: 'success', title: 'Tercatat!', text: `Sholat ${nama} jam ${jamSkrg}`, background: '#2d3436', color: '#fff' });
        }
    };

    function setDone(i) {
        const t = new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}).replace('.',':');
        document.getElementById(`badge-${i}`).innerText = t;
        document.getElementById(`card-${i}`).classList.add('done');
    }

    // Fungsi perbaikan jam 1899 untuk Laporan Guru
    function formatJamLaporan(val) {
        if (!val || val === "--:--" || val === "") return "--:--";
        if (typeof val === 'string' && val.includes('T')) {
            try {
                const d = new Date(val);
                return d.getHours().toString().padStart(2, '0') + ":" + d.getMinutes().toString().padStart(2, '0');
            } catch (e) { return val; }
        }
        return val;
    }

    async function renderMonitoring() {
        document.getElementById('subJudulGuru').innerText = GURU_TERPILIH;
        document.getElementById('tabelData').innerHTML = "<p style='text-align:center;'>Memuat data...</p>";
        try {
            const r = await fetch(SCRIPT_URL);
            const data = await r.json();
            const f = data.filter(x => x[3] === GURU_TERPILIH);
            let h = `<table><thead><tr><th>NO</th><th>NAMA</th><th>KLS</th><th>TGL</th><th>BANGUN</th><th>IBADAH</th><th>SHOLAT</th><th>OLAH</th><th>MAKAN</th><th>BELAJAR</th><th>SOSIAL</th><th>TIDUR</th><th>REFLEKSI</th></tr></thead><tbody>`;
            f.forEach((r, i) => {
                h += `<tr><td>${i+1}</td><td><b>${r[2]}</b></td><td>${r[1]}</td><td>${r[0]}</td>
                <td>${formatJamLaporan(r[4])}</td><td>${formatJamLaporan(r[5])}</td><td>${formatJamLaporan(r[6])}</td><td>${formatJamLaporan(r[7])}</td>
                <td>${formatJamLaporan(r[8])}</td><td>${formatJamLaporan(r[9])}</td><td>${formatJamLaporan(r[10])}</td><td>${formatJamLaporan(r[11])}</td>
                <td style='text-align:left; font-size:0.7rem;'>${r[12]}</td></tr>`;
            });
            document.getElementById('tabelData').innerHTML = h + `</tbody></table>`;
        } catch(e) { document.getElementById('tabelData').innerHTML = "Gagal memuat."; }
    }

    function move(id) {
        document.querySelectorAll('.container').forEach(e => e.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        if(id === 'p-guru') document.getElementById(id).classList.add('guru-mode');
    }

    function loadNama() {
        const k = document.getElementById('i-kelas').value;
        const f = DB_SISWA.filter(x => x[0] === k);
        let h = `<select id="i-nama" class="input-box" onchange="setWali()"><option value="">-- PILIH NAMA --</option>`;
        f.forEach(m => h += `<option value="${m[1]}">${m[1]}</option>`);
        document.getElementById('c-nama').innerHTML = h + `</select>`;
    }

    function setWali() {
        const n = document.getElementById('i-nama').value;
        const k = document.getElementById('i-kelas').value;
        const d = DB_SISWA.find(x => x[0] === k && x[1] === n);
        document.getElementById('i-wali').value = d ? d[2] : "";
    }

    async function loginGuru() {
        const { value: pass } = await Swal.fire({ title: 'AKSES GURU', input: 'password', inputPlaceholder: 'Password', showCancelButton: true });
        if (pass === "guru123") {
            const listWali = [...new Set(DB_SISWA.map(x => x[2]))].sort();
            let opt = {}; listWali.forEach(w => opt[w] = w);
            const { value: wali } = await Swal.fire({ title: 'Pilih Wali Kelas', input: 'select', inputOptions: opt, showCancelButton: true });
            if (wali) { GURU_TERPILIH = wali; move('p-guru'); renderMonitoring(); }
        } else if(pass) { Swal.fire('Salah!', '', 'error'); }
    }

    async function kirimData() {
        const tgl = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        const payload = {
            tanggal: tgl,
            kelas: document.getElementById('i-kelas').value,
            nama: document.getElementById('i-nama')?.value,
            wali: document.getElementById('i-wali').value,
            h: HABITS.map((_, i) => document.getElementById(`badge-${i}`).innerText),
            refleksi: document.getElementById('i-ref').value
        };
        if(!payload.nama) return Swal.fire('Pilih Nama!', '', 'warning');
        Swal.fire({ title: 'Menyimpan...', didOpen: () => Swal.showLoading() });
        try {
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
            Swal.fire('Berhasil!', '', 'success').then(() => location.reload());
        } catch(e) { Swal.fire('Gagal!', '', 'error'); }
    }
</script>
</body>
</html>